#!/bin/sh
# Copyright 2008 Bernd Steinhauser <berniyh@exherbo.org>
# Copyright 2008 Benjamin Kellermann
# Copyright 2008 Pascal Hauck
# Copyright 2008 Erik Streb del Toro
# Distributed under the terms of the GNU General Public License v3


# colours in the Bash
normal="\033[0m"
red="\033[31m"
orange="\033[33m"
green="\033[32m"

if [ -f "${NEO_CONFIG}" ]; then
	. "${NEO_CONFIG}" || die "Failed to source ${NEO_CONFIG}"
elif [ -f "${HOME}"/.neorc ]; then
	. "${HOME}"/.neorc || die "Failed to source ${HOME}/.neorc"
elif [ -f /etc/neo.conf ]; then
	. /etc/neo.conf || die "Failed to source /etc/neo.conf"
else
	echo "No configuration file found. Using default values, this might fail!"
fi


# Default values
STD_X_VARIANTE=${STD_X_VARIANTE:-xkbmap}
STD_XKBMAP=${STD_XKBMAP:-de}
STD_XKBVARIANT=${STD_XKBVARIANT:-nodeadkeys}
STD_CONSOLE_KEYMAP="${STD_CONSOLE_KEYMAP:-de-latin1-nodeadkeys}"
NUM_LOCK_STATUS=${NUM_LOCK_STATUS:-on}

help() {
cat <<HELP
Aufruf: $0 [-q]
Aktiviert die Standard-Tastaturbelegung.

  -q, --quiet		gibt – abgesehen von Fehlern – keine Meldungen aus

NEO-Tastaturbelegung
Homepage: http://neo-layout.org/

HELP
exit 0
}

die() {
	echo -e "${red}$@${normal}" >&2
	echo -e "${red}Die Belegung konnte nicht geändert werden.${normal}"
	exit 1
}

set_xmodmap() {
	if [ -f "$@" ]; then
		xmodmap "$@" || die "Failed to set xmodmap $@."
	else
		die "Cannot use $@ for xmodmap."
	fi
}

set_xkbmap() {
	setxkbmap "$@" || die "Failed to select xkbmap $@."
}

set_keymap() {
	if [ "${EUID}" = 0 ]; then
		loadkeys "$@" || die "Fehler beim Laden der Keymap ${orange}$@${red}."
	else
		sudo loadkeys "$@" || die "Fehler bei der Verwendung von ${orange}sudo${red}, um die Belegung zu ändern."
	fi
}

if [ -n "$SSH_CONNECTION" ]; then
	die "In einer ssh-session kann die Belegung nicht geändert werden."
fi

if [ -z ${DISPLAY} ]; then
	set_keymap "${STD_CONSOLE_KEYMAP}"

	if [ "${NUM_LOCK_STATUS}" = "on" ]; then
		setleds -num || echo -e "${orange}Fehler beim setzen des Status von NumLock.${normal}" >&2
	else
		setleds +num || echo "${orange}Fehler beim setzen des Status von NumLock.${normal}" >&2
	fi

else
	for modifier in 51 94; do
		xset r ${modifier} || echo "Failed to set repeat for modifier ${modifier}." >&2
	done
	for deadkey in 21 35 49; do
		xset r ${deadkey} || echo "Failed to set repeat for deadkey ${deakey}." >&2
	done


	case "${STD_X_VARIANTE}" in
		xkbmap)
			set_xkbmap "${STD_XKBMAP}" "${STD_XKBVARIANT}"
			;;
		xmodmap)
			set_xkbmap de
			set_xmodmap "${STD_XMODMAP}"
			;;
		*)
			die "Unknown standard X variant ${STD_X_VARIANTE}."
			;;
	esac

	if [ "${NUM_LOCK_STATUS}" = "on" ]; then
		numlockx on || die "Failed to set num lock status to on."
	else
		numlockx off || die "Failed to set num lock status to off."
	fi
fi

